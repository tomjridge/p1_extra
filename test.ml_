(* -*- mode: tuareg -*- *)

(* interactive top-level testing having installed ml files *)

#require "p1_core";;
#require "p1_extra";;



(* examples --------------------------------------------------------- *)

open Tjr_substring
open P1_combinators 

(* for testing FIXME use Tjr_substring.a *)
let a1 (s:substring_) = (
  if s.i_ < s.j_ && s.s_.[s.i_] = '1' then
    [("1",{s with i_ = s.i_ + 1})]
  else
    [])

open P1_core

let a1 : string parser_ = (fun i -> a1 i.ss)

let _ = "11111" |> run_parser (iter ~n:5 a1)
let _ = "1111" |> run_parser (iter ~n:5 a1)
let _ = "111111" |> run_parser (iter ~n:5 a1)

;;
let _ = "1111" |> run_parser (star ~sep:eps a1)


(* parse_grammar_file ----------------------------------------------- *)

open Parse_grammar_file

let _ = grammar_to_parser

let example = {|

S -> E ?ws? ?eof? {{ print_endline (x1 |> string_of_int) }}

E -> E E E {{ x+y+z }}
| "1"  {{ 1 }}
| ""   {{ 0 }}

|}

let x = example |> run_parser (grammar_to_parser "Grammar")

(*

FIXME NOTE the following is rather verbose due to the generic nature of grammar_to_parser

FIXME too many nestings in the following?

val x :
  ([> `NT of string * [> `Alt_list of [> `Seq_list of 'a list ] ]
    | `Plus of 'a list
    | `Star of 'a list
    | `String of string ]
   as 'a)
  list =
  [`NT
     ("Grammar",
      `Alt_list
        (`Seq_list
           [`String "\n\n";
            `NT
              ("Rules",
               `Alt_list
                 (`Seq_list
                    [`Star
                       [`NT
                          ("Rule",
                           `Alt_list
                             (`Seq_list
                                [`NT
                                   ("Sym",
                                    `Alt_list
                                      (`Seq_list
                                         [`NT
                                            ("NT",
                                             `Alt_list
                                               (`Seq_list [`String "S"]))]));
                                 `String " "; `String "->"; `String " ";
                                 `NT
                                   ("Rhs",
                                    `Alt_list
                                      (`Seq_list
                                         [`Plus
                                            [`NT
                                               ("Symsact",
                                                `Alt_list
                                                  (`Seq_list
                                                     [`NT
                                                        ("Syms",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`Plus
                                                                 [`NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("NT",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "E"]))]));
                                                                  `NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("TM",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "?";
                                                                    `String
                                                                    "ws";
                                                                    `String
                                                                    "?"]))]));
                                                                  `NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("TM",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "?";
                                                                    `String
                                                                    "eof";
                                                                    `String
                                                                    "?"]))]))]]));
                                                      `String " ";
                                                      `NT
                                                        ("Code",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`String "{{";
                                                               `String
                                                                 " print_endline (x1 |> string_of_int) ";
                                                               `String "}}"]))]))]]))]));
                        `NT
                          ("Rule",
                           `Alt_list
                             (`Seq_list
                                [`NT
                                   ("Sym",
                                    `Alt_list
                                      (`Seq_list
                                         [`NT
                                            ("NT",
                                             `Alt_list
                                               (`Seq_list [`String "E"]))]));
                                 `String " "; `String "->"; `String " ";
                                 `NT
                                   ("Rhs",
                                    `Alt_list
                                      (`Seq_list
                                         [`Plus
                                            [`NT
                                               ("Symsact",
                                                `Alt_list
                                                  (`Seq_list
                                                     [`NT
                                                        ("Syms",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`Plus
                                                                 [`NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("NT",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "E"]))]));
                                                                  `NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("NT",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "E"]))]));
                                                                  `NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("NT",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "E"]))]))]]));
                                                      `String " ";
                                                      `NT
                                                        ("Code",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`String "{{";
                                                               `String
                                                                 " x+y+z ";
                                                               `String "}}"]))]));
                                             `NT
                                               ("Symsact",
                                                `Alt_list
                                                  (`Seq_list
                                                     [`NT
                                                        ("Syms",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`Plus
                                                                 [`NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT
                                                                    ("TM",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`String
                                                                    "\"";
                                                                    `String
                                                                    "1";
                                                                    `String
                                                                    "\""]))]))]]));
                                                      `String "  ";
                                                      `NT
                                                        ("Code",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`String "{{";
                                                               `String " 1 ";
                                                               `String "}}"]))]));
                                             `NT
                                               ("Symsact",
                                                `Alt_list
                                                  (`Seq_list
                                                     [`NT
                                                        ("Syms",
                                                         `Alt_list
                                                           (`Seq_list
                                                              [`Plus
                                                                 [`NT
                                                                    ("Sym",
                                                                    `Alt_list
                                                                    (`Seq_list
                                                                    [`NT ...]));
                                                                    ...];
                                                                 ...]));
                                                        ...]));
                                               ...];
                                            ...]));
                                   ...]));
                          ...];
                       ...]));
              ...]));
     ...]
# 

*)
