(* -*- mode: tuareg -*- *)

(* interactive top-level testing having installed ml files *)

#require "p1_core";;
#require "p1_extra";;



(* examples --------------------------------------------------------- *)

open Tjr_substring
open P1_combinators 

(* for testing FIXME use Tjr_substring.a *)
let a1 (s:substring_) = (
  if s.i_ < s.j_ && s.s_.[s.i_] = '1' then
    [("1",{s with i_ = s.i_ + 1})]
  else
    [])

open P1_core

let a1 : string parser_ = (fun i -> a1 i.ss)

let _ = "11111" |> run_parser (iter ~n:5 a1)
let _ = "1111" |> run_parser (iter ~n:5 a1)
let _ = "111111" |> run_parser (iter ~n:5 a1)

;;
let _ = "1111" |> run_parser (star ~sep:eps a1)


(* parse_grammar_file ----------------------------------------------- *)

open Parse_grammar_file

let _ = grammar_to_parser

let example = {|

S -> E ?ws? ?eof? {{ print_endline (x1 |> string_of_int) }}

E -> E E E {{ x+y+z }}
| "1"  {{ 1 }}
| ""   {{ 0 }}

|}

let x = example |> run_parser (grammar_to_parser "Grammar")

(*

FIXME NOTE the following is rather verbose due to the generic nature of grammar_to_parser

# let _ = example |> run_parser (grammar_to_parser "Grammar");;
- : ([> `Alt_list of string * [> `Seq_list of 'a list ]
      | `Plus of 'a list
      | `Star of 'a list
      | `String of string ]
     as 'a)
    list
=
[`Alt_list
   ("Grammar",
    `Seq_list
      [`String "\n\n";
       `Alt_list
         ("Rules",
          `Seq_list
            [`Star
               [`Alt_list
                  ("Rule",
                   `Seq_list
                     [`Alt_list
                        ("Sym",
                         `Seq_list
                           [`Alt_list ("NT", `Seq_list [`String "S"])]);
                      `String " "; `String "->"; `String " ";
                      `Alt_list
                        ("Rhs",
                         `Seq_list
                           [`Plus
                              [`Alt_list
                                 ("Symsact",
                                  `Seq_list
                                    [`Alt_list
                                       ("Syms",
                                        `Seq_list
                                          [`Plus
                                             [`Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("NT",
                                                       `Seq_list
                                                         [`String "E"])]);
                                              `Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("NT",
                                                       `Seq_list
                                                         [`String "?";
                                                          `String "ws";
                                                          `String "?"])]);
                                              `Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("NT",
                                                       `Seq_list
                                                         [`String "?";
                                                          `String "eof";
                                                          `String "?"])])]]);
                                     `String " ";
                                     `Alt_list
                                       ("Code",
                                        `Seq_list
                                          [`String "{{";
                                           `String
                                             " print_endline (x1 |> string_of_int) ";
                                           `String "}}"])])]])]);
                `Alt_list
                  ("Rule",
                   `Seq_list
                     [`Alt_list
                        ("Sym",
                         `Seq_list
                           [`Alt_list ("NT", `Seq_list [`String "E"])]);
                      `String " "; `String "->"; `String " ";
                      `Alt_list
                        ("Rhs",
                         `Seq_list
                           [`Plus
                              [`Alt_list
                                 ("Symsact",
                                  `Seq_list
                                    [`Alt_list
                                       ("Syms",
                                        `Seq_list
                                          [`Plus
                                             [`Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("NT",
                                                       `Seq_list
                                                         [`String "E"])]);
                                              `Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("NT",
                                                       `Seq_list
                                                         [`String "E"])]);
                                              `Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("NT",
                                                       `Seq_list
                                                         [`String "E"])])]]);
                                     `String " ";
                                     `Alt_list
                                       ("Code",
                                        `Seq_list
                                          [`String "{{"; `String " x+y+z ";
                                           `String "}}"])]);
                               `Alt_list
                                 ("Symsact",
                                  `Seq_list
                                    [`Alt_list
                                       ("Syms",
                                        `Seq_list
                                          [`Plus
                                             [`Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("TM",
                                                       `Seq_list
                                                         [`String "\"";
                                                          `String "1";
                                                          `String "\""])])]]);
                                     `String "  ";
                                     `Alt_list
                                       ("Code",
                                        `Seq_list
                                          [`String "{{"; `String " 1 ";
                                           `String "}}"])]);
                               `Alt_list
                                 ("Symsact",
                                  `Seq_list
                                    [`Alt_list
                                       ("Syms",
                                        `Seq_list
                                          [`Plus
                                             [`Alt_list
                                                ("Sym",
                                                 `Seq_list
                                                   [`Alt_list
                                                      ("TM",
                                                       `Seq_list
                                                         [`String "\"";
                                                          `String "";
                                                          `String "\""])])]]);
                                     `String "   ";
                                     `Alt_list
                                       ("Code",
                                        `Seq_list
                                          [`String "{{"; `String " 0 ";
                                           `String "}}"])])]])])]]);
       `String "\n\n"; `String ""])]

*)
